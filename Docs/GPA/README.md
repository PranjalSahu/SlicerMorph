## GPA
**Summary:** This module performs Generalized Procrustes Analysis (GPA) with or without scaling shape configurations to unit size, conducts principal component analysis (PCA) of GPA aligned shape coordinates, provides graphical output of GPA results and real-time 3D visualization of PC warps either using the landmarks of mean shape, or using a reference model that is transformed into the mean shape. Visualization of 3D shape deformation of the reference model can be exported as video clips. The input into the module is a folder path containing a number of landmark files stored in Slicerâ€™s fcsv format and optionally a 3D model and accompanying set of landmarks to be used as reference model in 3D visualization of PCA results. Aesthetics (label shape, text size etc) of the morphospace plots (aka PC scatter plot) can be further customized using the `Plots` module of Slicer.

### USAGE
#### Setup analysis:
This section of the module runs the GPA and PCA analysis on a directory of landmark files. For data sets with a large number of landmarks, please expect running this step to take several minutes.

* __Select Landmark Files:__ Use file dialog box to highlight and select samples to be included in the analysis. The files can be `.fcsv` or `.mrk.json` format. There should be one  file per subject. Filenames are used as subject IDs in analysis. Selected files will be displayed in the table below the *View Selected Files*.

* __Output directory prefix:__ Use the output directory field to select the directory where the results will be written. Each time the `GPA` module is run, a new timestamped results folder is created in this directory to prevent results from being overwritten. Please ensure that you have write access to the specified directory. Output folder will contain a log file that lists the files and the settings used in the analysis. This file can be parsed by convinence function [_log_parser.R_ ](https://raw.githubusercontent.com/muratmaga/SlicerMorph_Rexamples/main/log_parser.R) for further analysis in R.

* __Exclude landmarks:__ Optionally, landmarks can be excluded from analysis. Please enter the number of each landmark to exclude, seperated by commas (example: 25,27,29). If all landmarks will be used, this field can be left empty.

* __Skip Scaling:__ Option to skip the scaling step in the GPA. Useful to keep the physical scale of the data.

* __Execute GPA + PCA:__ Initiates the GPA and also calculates the major axis of shape variaiton using PCA decomposition. PCA may take up to few minutes for large datasets.

* __View Output Folder:__ Pops up a file browser and shows the contents of specified output folder.

#### Load previous analysis
As an alternative to running the GPA and PCA analysis, the module can be used to browse and visulize the results from a previous run of the module.

* __Results directory:__ Use the directory selector to choose the output results folder generated by a previous run of the `GPA` module. This folder name will include a timestamp documenting the date/time of the anlysis.

#### Mean shape plot options
This section provides options for quickly and easily interacting with the display of the Procrustes mean shape without leaving the `GPA` module. If there is a warped display of the mean shape in the second 3D viewer, it will also control the display properties for this model. If a more customized display is needed, more display properties are available in the `Markups` module.

* __Mean shape visibility:__ Toggle the visibility of the mean shape landmark points.

* __Mean point label visibility:__ Toggle the visibility of the mean shape landmark names.

* __Mean shape color:__ Select a new color for the mean shape landmark points.

* __Mean shape glyph scale:__ Adjust the scale of the mean shape landmark points.

#### Landmark variance plot options
This section creates a visualization of the Procrustes distance variance at each point in mean shape, displayed in the 3D viewer. The visualizations are scaled by the size of the mean shape for visibility, and should be used assess relative, rather than absolute variance. Each landmark point is assigned a unique, randomlu assigned color that is not associated with the magnitude of variance.

* __Ellipse type:__ The variance is plotted as an ellipse at each point with the radius in each dimension corresponding to the amount of variance along that axis.

* __Sphere type:__ The variance is plotted as a sphere at each point with a radius dertermined by the average variance across three dimensions.

* __Point cloud:__ Plots GPA aligned landmark coordinates for the entire data set as a point cloud.

#### PCA scatter plot options
This section creates a 2D scatter plot of two selected principal component scores in the Plot Viewer. The menu options are used to select the principal components on each axis, or optionally group subjects using factor data.

* __X Axis:__ Select the PC on the X-axis.

* __Y Axis:__ Select the PC on the Y-axis.

* __Factor name:__ Input the title of the factor to be added. Click `Add factor data` to display a table with the factor added as a column header. Input the factor data under this header.

* __Select factor:__ To group subjects in the PC scatter plot using the input factor data, select a factor from the dropdown menu. Each factor grouping will be displayed in the PC scatter plot with a unique, random color.

#### Lollipop plot options
This section creates a visualization of the eigenvectors associated with each principal component in the 3D viewer. This vector indicates how the mean shape will change along the positive values of the selected PC. Between one and three PC vectors can be displayed simultaneously.

* __Vector one: red__ Select the first PC, which will be displayed in red.

* __Vector two: green__ Optionally select an additional PC that will be displayed in green.

* __Vector three: blue__ Optionally select an additional PC that will be displayed in blue.

* __Lollipop 2D projection__ Option to project the vector visualization from the 3D viewer to a 2D view.

#### Setup interactive visualization
This section sets up an interactive visualization demonstrating how selected principal components impact the mean shape. The visualization can be shown using only the Procrustes mean shape calculated in the first step of the `GPA` module, which requires no additional data. Alternatively, the impact of each PC can be shown on a reference model. This option requires a representative 3D model with and a corresponding landmark file. When the interactive visualization has been set up, a the mean shape or reference model that will be warped by the PCs is displayed in the second 3D viewer.

* __Mean shape visualization__ This option selects the default visualization, which displays the impact of the PCs on the mean shape landmarks only.

* __3D model visualization__ This option will set up the interactive visualization using a sample mesh to show the impact of the PCs, if a model and corresponding landmark file are loaded.

* __Specify reference model__ If the `3D model visualization` option was chosen, this field is used to select the model. Supported model filetypes include: `.ply`, `.stl`, `.obj`, `.vtk`, `.vtp`, `.orig`, `.g`, and `.byu`.

* __Specify landmark set for selected model__ If the `3D model visualization` option was chosen, this field is used to select the `.fcsv` file containing the model's corresponding landmarks.

#### PCA visualization parameters
This section allows the user to visualize the influence of select principal components on the mean shape landmarks or reference model displayed the second 3D viewer. The original mean shape or model remains in the first 3D viewer for comparison. The PC selectors allow up to two PCs to be selected and their influence to be modulated in both the positive and negative direction interactively using the slider bars.

* __PC Selector One__ Select the first principal component and scaling factor.

* __PC Selector Two__ Optionally select the second principal component and scaling factor.

#### Create animation of PC warping
This section allows the user to capture a PC deformation as an animation. The animation created can be exported using the `Screen Capture` module, which supports several video export formats, including `mp4`.

* __Start recording__ Begins recording the warping applied to the mean shape landmarks or reference model.

* __Stop recording__  Ends recording the warping applied to the mean shape landamrks or reference model.

### LIMITATIONS
As implemented, GPA module does not allow sliding of the semi or pseudoLMs during superimposition. If sliding is required, we advise using the R/geomorph package for GPA superimposition.

### TUTORIAL
For more information how to use the module, please see:

1. [GPA Basics](https://github.com/SlicerMorph/Tutorials/tree/main/GPA_1)
2. [GPA Exploring morphospaces](https://github.com/SlicerMorph/Tutorials/tree/main/GPA_2)
3. [GPA Exporing Data to R](https://github.com/SlicerMorph/Tutorials/tree/main/GPA_3)

There are also video tutorials available. Note that while the UI might be slightly different, the functionality is the same:
1. [Basics of GPA](https://www.youtube.com/watch?v=FCeZ2J5Uvcw&t=215s)
2. [Visualizing shape deformation with a reference model:](https://www.youtube.com/watch?v=hMMR9GChek8&t=240s)
3. [Recording shape deformations as an animation:](https://www.youtube.com/watch?v=gtHqhqaKeCU)





